#!/system/bin/sh
exec >>/dev/null
######
[ ! "$(whoami)" = "root" ] && echo " » Please use root privileges!" && exit 1
######
bin_dir=$(ClearBox -b)
home_dir=$(ClearBox -h)
work_dir=$(ClearBox -w)
source "$work_dir/settings.prop"
whitelist="$work_dir/whitelist.prop"
data_dir="/data/user"
micro_dir="/mnt/expand/$(ls "/mnt/expand/")/user"
######
if ! grep "=" "$work_dir/RunStart" >>/dev/null; then
    echo "1=" > "$work_dir/RunStart"
    echo "2=" >> "$work_dir/RunStart"
    echo "reset=" >> "$work_dir/RunStart"
fi
######
while true; do
    # Get now package
    NowPackageName=$(dumpsys window | grep mCurrentFocus | head -n 1 | cut -f 1 -d '/' | cut -f 5 -d ' ' | cut -f 1 -d ' ')
    ######
    GetPackage()
    {
    # Get前台包名数据
    NowApp1=$(grep ^"1=" "$work_dir/RunStart" | cut -f2 -d '=')
    NowApp2=$(grep ^"2=" "$work_dir/RunStart" | cut -f2 -d '=')
    reset_app=$(grep ^"reset=" "$work_dir/RunStart" | cut -f2 -d '=')
    }
    ######
    # 检查屏幕状态/更新数据
    if echo "$NowPackageName" | grep "StatusBar" >/dev/null; then
        sleep 30
        continue
    else
        if ! grep ^"1=$NowPackageName" "$work_dir/RunStart" >/dev/null; then
            sed -i "s/reset=$reset_app/reset=$NowApp2/g" "$work_dir/RunStart"
            sed -i "s/2=$NowApp2/2=$NowApp1/g" "$work_dir/RunStart"
            sed -i "s/1=$NowApp1/1=$NowPackageName/g" "$work_dir/RunStart"
        else
            sleep 10
            continue
        fi
    fi
    ######
    GetPackage
    ######
    Stop_UserCache()
    {
    # 函数用于内部储存软件阻止缓存
    for userid_dir in "$data_dir"/*; do
        if [ -d "$userid_dir/$reset_app" ]; then
            chattr -R -i "$userid_dir/$reset_app/cache" && echo "Reset: $reset_app"
        fi
        if [ -d "$userid_dir/$NowApp1" ]; then
            if ! grep "$NowApp1" "$whitelist" >/dev/null; then
                chattr -R +i "$userid_dir/$NowApp1/cache" && echo "Stop: $NowApp1"
            fi
        fi
    done
    }
    ######
    Stop_MicroCache()
    {
    # 函数用于SD拓展卡软件阻止缓存
    ###
    for userid_dir in "$micro_dir"/*; do
        if [ -d "$userid_dir/$reset_app" ]; then
            chattr -R -i "$userid_dir/$reset_app/cache" && echo "Reset: $reset_app"
        fi
        if [ -d "$userid_dir/$NowApp1" ]; then
            if ! grep "$NowApp1" "$whitelist" >/dev/null; then
                chattr -R +i "$userid_dir/$NowApp1/cache" && echo "Stop: $NowApp1"
            fi
        fi
    done
    }
    ######
    Stop_UserCache &
    [ -d "$micro_dir" ] && Stop_MicroCache &
    wait
    sleep 10
done
