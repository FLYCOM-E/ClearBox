name: Building modules

on:
  workflow_dispatch:
    inputs:
      api_level:
        description: 'Android API Level'
        required: false
        default: '21'
      ndk_version:
        description: 'NDK Version'
        required: false
        default: 'r28b'
    
  push:
    branches:
      - main
    paths:
      - 'Module_Files/module.prop'

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64, armv7a, x86_64, i686]
        language: [zh_CN, en_US, zh_TW]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get version info from module.prop
        id: get_version
        run: |
          VERSION=$(grep '^version=' Module_Files/module.prop | cut -d'=' -f2)
          VERSION_CODE=$(grep '^versionCode=' Module_Files/module.prop | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
      
      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ github.event.inputs.ndk_version || 'r28b' }}
          add-to-path: true
      
      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: ${{ steps.setup-ndk.outputs.ndk-path }}
          key: ndk-${{ github.event.inputs.ndk_version || 'r28b' }}-${{ runner.os }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip make
      
      - name: Build ${{ matrix.language }} - ${{ matrix.target }}
        run: |
          chmod +x *
          export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          export M_API=${{ github.event.inputs.api_level || '21' }}
          export M_LANG=${{ matrix.language }}
          export M_TARGET=${{ matrix.target }}
          bash build.sh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ClearBox-${{ steps.get_version.outputs.version }}-${{ steps.get_version.outputs.versionCode }}-${{ matrix.language }}-${{ matrix.target }}
          path: ./*.zip
          if-no-files-found: error
  
  collect:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected_artifacts
      
      - name: Update JSON files and Commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          LANGS=("zh_CN" "en_US" "zh_TW")
          ARCHS=("aarch64" "armv7a" "x86_64" "i686")
          
          VERSION=$(grep '^version=' Module_Files/module.prop | cut -f2 -d '=')
          VERSION_CODE=$(grep '^versionCode=' Module_Files/module.prop | cut -f2 -d '=')
          
          echo "Updating JSON files with version $VERSION..."
          
          for lang in "${LANGS[@]}"; do
            for arch in "${ARCHS[@]}"; do
              JSON_PATH="UpdateJson/$lang/update_$arch.json"
              
              if [ -f "$JSON_PATH" ]; then
                ZIP_NAME="ClearBox-$VERSION-$VERSION_CODE-$lang-$arch.zip"
                ZIP_URL="https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/$ZIP_NAME"
                
                sed -i "s|\"zipUrl\": \".*\"|\"zipUrl\": \"$ZIP_URL\"|g" "$JSON_PATH"
                sed -i "s|\"version\": \".*\"|\"version\": \"$VERSION\"|g" "$JSON_PATH"
                sed -i "s|\"versionCode\": .*|\"versionCode\": $VERSION_CODE,|g" "$JSON_PATH"
                echo "Updated $JSON_PATH with $ZIP_URL"
              fi
            done
          done
          
          if git diff --quiet UpdateJson/; then
            echo "No changes to JSON files."
          else
            git add UpdateJson/
            git commit -m "Update: Version Code $VERSION_CODE update.json's"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
